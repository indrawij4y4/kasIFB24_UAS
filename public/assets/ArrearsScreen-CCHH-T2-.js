import{j as e,l as T,a as W,S as Y,h as P}from"./ui-DF08lGNp.js";import{c as Q,r as c}from"./vendor-S3JaNCHW.js";import{u as p}from"./useQuery-DuxVUDsr.js";import{a as B,c as _,p as E,b as j,h as J}from"./index-CdnzfiEJ.js";import{u as R}from"./useMutation-BLnDG93L.js";import{S as y,M as k}from"./Select-CKwvDmYb.js";const b=new Date().getMonth()+1,m=new Date().getFullYear(),$=()=>{const o=new Date,i=new Date(o.getFullYear(),o.getMonth(),1),s=o.getDate(),x=i.getDay();return Math.ceil((s+x)/7)};function Z(){const o=Q(),i=B(),[s,x]=c.useState(b.toString()),[t,N]=c.useState(m.toString()),[r,d]=c.useState({open:!1,studentName:"",studentNim:"",userId:null,week:null}),[w,f]=c.useState(!1),M=$(),S=parseInt(s)===b&&parseInt(t)===m,I=parseInt(t)<m||parseInt(t)===m&&parseInt(s)<b,{data:g,isLoading:C}=p({queryKey:["arrears",s,t],queryFn:()=>j.getArrears(parseInt(s),parseInt(t))}),{data:D}=p({queryKey:["users"],queryFn:J.getAll}),{data:h}=p({queryKey:["settings",s,t],queryFn:()=>j.getSettings(parseInt(s),parseInt(t))}),q=a=>a.unpaid_weeks||[],A=a=>a.total_unpaid||0,v=R({mutationFn:async()=>{if(!(!r.userId||!r.week||!h))return E.store({user_id:r.userId,bulan:parseInt(s),tahun:parseInt(t),minggu_ke:r.week,nominal:h.weeklyFee})},onSuccess:()=>{i.invalidateQueries({queryKey:["arrears"]}),i.invalidateQueries({queryKey:["students"]}),i.invalidateQueries({queryKey:["dashboardStats"]}),d(a=>({...a,open:!1})),f(!0)},onError:a=>{alert("Gagal memproses pembayaran: "+(a.message||"Unknown error")),d(n=>({...n,open:!1}))}}),F=(a,n)=>{const u=D?.find(l=>l.nim===a.nim);u?d({open:!0,studentName:a.name||a.nama||"Mahasiswa",studentNim:a.nim,userId:u.id,week:n}):alert("Data user tidak ditemukan untuk mahasiswa ini.")},K=[{label:"Januari",value:"1"},{label:"Februari",value:"2"},{label:"Maret",value:"3"},{label:"April",value:"4"},{label:"Mei",value:"5"},{label:"Juni",value:"6"},{label:"Juli",value:"7"},{label:"Agustus",value:"8"},{label:"September",value:"9"},{label:"Oktober",value:"10"},{label:"November",value:"11"},{label:"Desember",value:"12"}],L=[{label:"2024",value:"2024"},{label:"2025",value:"2025"},{label:"2026",value:"2026"}];return e.jsxs("div",{className:"p-6 bg-background min-h-screen animate-fadeIn pb-32",children:[e.jsxs("div",{className:"flex flex-col gap-6 mb-8",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>o("/"),className:"w-12 h-12 bg-card rounded-2xl shadow-sm border border-border flex items-center justify-center text-muted-foreground active:scale-95 transition-all hover:border-blue-200 hover:text-blue-500 hover:shadow-md group",children:e.jsx(T,{className:"w-6 h-6 group-hover:-translate-x-0.5 transition-transform"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"Daftar Tunggakan"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Kelola tagihan anggota yang belum lunas"})]})]}),e.jsx("div",{className:"bg-card p-4 rounded-2xl shadow-sm border border-border",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(y,{label:"Bulan",value:s,onChange:a=>x(a.target.value),options:K}),e.jsx(y,{label:"Tahun",value:t,onChange:a=>N(a.target.value),options:L})]})})]}),C?e.jsx("div",{className:"min-h-[300px] flex items-center justify-center",children:e.jsx(W,{className:"w-8 h-8 animate-spin text-primary"})}):h?.weeklyFee?e.jsxs("div",{className:"space-y-3",children:[g?.map(a=>{const n=q(a),u=A(a);return n.length===0?null:e.jsxs("div",{className:"bg-card p-4 rounded-3xl border border-border shadow-sm relative overflow-hidden group",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1.5 bg-rose-500 rounded-l-3xl"}),e.jsxs("div",{className:"flex justify-between items-center mb-3 pl-3",children:[e.jsxs("div",{className:"flex-1 min-w-0 mr-4",children:[e.jsx("h3",{className:"font-bold text-base text-foreground truncate",children:a.name}),e.jsx("p",{className:"text-xs text-muted-foreground font-medium tracking-wide",children:a.nim})]}),e.jsxs("div",{className:"text-right shrink-0",children:[e.jsxs("span",{className:"text-sm font-black text-rose-600 dark:text-rose-400 block",children:["Rp ",u.toLocaleString("id-ID")]}),e.jsxs("span",{className:"text-[10px] font-bold text-muted-foreground",children:[n.length," Minggu Belum"]})]})]}),e.jsx("div",{className:"pl-3",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:n.map(l=>{const O=I||S&&l<M;return e.jsxs("button",{onClick:()=>F(a,l),className:_("text-[10px] font-bold px-3 py-1.5 rounded-lg border transition-all active:scale-95",O?"bg-rose-600 text-white border-rose-700 shadow-sm hover:bg-rose-700":"bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 border-rose-100 dark:border-rose-900/30 hover:bg-rose-100 dark:hover:bg-rose-900/30"),children:["M",l]},l)})})})]},a.nim)}),(!g||g.length===0)&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-emerald-100 dark:bg-emerald-900/20 rounded-full flex items-center justify-center text-emerald-500 dark:text-emerald-400 mb-2",children:e.jsx(P,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-foreground",children:"Tidak Ada Tunggakan"}),e.jsx("p",{className:"text-muted-foreground text-sm max-w-[200px] mx-auto",children:"Semua anggota telah melunasi iuran untuk periode ini."})]})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center space-y-4 bg-card rounded-3xl border border-dashed border-border",children:[e.jsx("div",{className:"w-16 h-16 bg-muted rounded-full flex items-center justify-center text-muted-foreground mb-2",children:e.jsx(Y,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-foreground",children:"Belum Ada Pengaturan"}),e.jsx("p",{className:"text-muted-foreground text-sm max-w-[250px] mx-auto",children:"Admin belum mengatur tagihan kas untuk periode ini. Silakan atur terlebih dahulu di pengaturan."})]})]}),e.jsx(k,{isOpen:r.open,onClose:()=>d(a=>({...a,open:!1})),onConfirm:()=>v.mutate(),title:"Konfirmasi Pelunasan",description:r.userId?`Tandai iuran Minggu ${r.week} untuk ${r.studentName} sebagai lunas?`:"",type:"confirm",confirmLabel:v.isPending?"Memproses...":"Ya, Lunas"}),e.jsx(k,{isOpen:w,onClose:()=>f(!1),title:"Berhasil",description:"Iuran berhasil dilunasi.",type:"success"})]})}export{Z as ArrearsScreen};
