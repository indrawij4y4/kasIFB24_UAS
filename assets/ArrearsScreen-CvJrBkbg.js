import{j as e,y as B,a as P,S as W,h as _}from"./ui-ojUPcdkR.js";import{c as Q,r as x}from"./vendor-S3JaNCHW.js";import{u as f}from"./useQuery-DrWLbDdI.js";import{b as Y,c as R,p as M,a as I,f as $}from"./index-b6SL6hsZ.js";import{u as J}from"./useMutation-CvMS9LLC.js";import{S as G}from"./Select-0tL3yPF9.js";import{M as k}from"./Modal-ChpNS6wC.js";const v=new Date().getMonth()+1,g=new Date().getFullYear(),U=()=>{const o=new Date,u=new Date(o.getFullYear(),o.getMonth(),1),t=o.getDate(),p=u.getDay();return Math.ceil((t+p)/7)};function ae(){const o=Q(),u=Y(),[t,p]=x.useState(v.toString()),n=g.toString(),[a,d]=x.useState({open:!1,studentName:"",studentNim:"",userId:null,week:null}),[b,c]=x.useState({isOpen:!1,message:""}),[S,j]=x.useState(!1),C=U(),D=parseInt(t)===v&&parseInt(n)===g,O=parseInt(n)<g||parseInt(n)===g&&parseInt(t)<v,A=10*1e3,{data:m,isLoading:q}=f({queryKey:["arrears",t,n],queryFn:()=>I.getArrears(parseInt(t),parseInt(n)),staleTime:5*1e3,refetchInterval:A}),{data:y}=f({queryKey:["users"],queryFn:$.getAll,staleTime:30*1e3}),{data:h}=f({queryKey:["settings",t,n],queryFn:()=>I.getSettings(parseInt(t),parseInt(n)),staleTime:30*1e3,refetchInterval:30*1e3}),N=s=>s.unpaid_weeks||[],T=s=>s.total_unpaid||0,w=J({mutationFn:async()=>{if(a.userId)return a.week===null?M.bulkStore({user_id:a.userId,bulan:parseInt(t),tahun:parseInt(n)}):h?M.store({user_id:a.userId,bulan:parseInt(t),tahun:parseInt(n),minggu_ke:a.week,nominal:h.weeklyFee}):void 0},onSuccess:()=>{u.invalidateQueries({queryKey:["arrears"]}),u.invalidateQueries({queryKey:["students"]}),u.invalidateQueries({queryKey:["dashboardStats"]}),d(s=>({...s,open:!1})),j(!0)},onError:s=>{c({isOpen:!0,message:"Gagal memproses pembayaran: "+(s.message||"Unknown error")}),d(r=>({...r,open:!1}))}}),F=(s,r)=>{const l=y?.find(i=>i.nim===s.nim);l?d({open:!0,studentName:s.name||s.nama||"Mahasiswa",studentNim:s.nim,userId:l.id,week:r}):c({isOpen:!0,message:"Data user tidak ditemukan untuk mahasiswa ini."})},L=s=>{const r=y?.find(l=>l.nim===s.nim);r?d({open:!0,studentName:s.name||s.nama||"Mahasiswa",studentNim:s.nim,userId:r.id,week:null}):c({isOpen:!0,message:"Data user tidak ditemukan untuk mahasiswa ini."})},K=[{label:"Januari",value:"1"},{label:"Februari",value:"2"},{label:"Maret",value:"3"},{label:"April",value:"4"},{label:"Mei",value:"5"},{label:"Juni",value:"6"},{label:"Juli",value:"7"},{label:"Agustus",value:"8"},{label:"September",value:"9"},{label:"Oktober",value:"10"},{label:"November",value:"11"},{label:"Desember",value:"12"}];return e.jsxs("div",{className:"p-6 bg-background min-h-screen animate-fadeIn pb-32",children:[e.jsxs("div",{className:"flex flex-col gap-6 mb-8",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>o("/"),className:"w-12 h-12 bg-card rounded-2xl shadow-sm border border-border flex items-center justify-center text-muted-foreground active:scale-95 transition-all hover:border-blue-200 hover:text-blue-500 hover:shadow-md group",children:e.jsx(B,{className:"w-6 h-6 group-hover:-translate-x-0.5 transition-transform"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"Daftar Tunggakan"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Kelola tagihan anggota yang belum lunas"})]})]}),e.jsx("div",{className:"bg-card p-4 rounded-2xl shadow-sm border border-border",children:e.jsx("div",{className:"grid grid-cols-1",children:e.jsx(G,{label:"Bulan",value:t,onChange:s=>p(s.target.value),options:K})})})]}),q?e.jsx("div",{className:"min-h-[300px] flex items-center justify-center",children:e.jsx(P,{className:"w-8 h-8 animate-spin text-primary"})}):h?.weeklyFee?e.jsxs("div",{className:"space-y-3",children:[m?.map(s=>{const r=N(s),l=T(s);return r.length===0?null:e.jsxs("div",{className:"bg-card p-4 rounded-3xl border border-border shadow-sm relative overflow-hidden group",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1.5 bg-rose-500 rounded-l-3xl"}),e.jsxs("div",{className:"flex justify-between items-center mb-3 pl-3",children:[e.jsxs("div",{className:"flex-1 min-w-0 mr-4",children:[e.jsx("h3",{className:"font-bold text-base text-foreground truncate",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground font-medium tracking-wide",children:s.nim})]}),e.jsxs("div",{className:"text-right shrink-0",children:[e.jsxs("span",{className:"text-sm font-black text-rose-600 dark:text-rose-400 block",children:["Rp ",l.toLocaleString("id-ID")]}),e.jsx("div",{className:"flex items-center justify-end gap-1.5 mt-0.5",children:e.jsxs("span",{className:"text-[10px] font-bold text-muted-foreground",children:[r.length," Minggu Belum"]})})]})]}),e.jsx("div",{className:"pl-3",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.map(i=>{const E=O||D&&i<C;return e.jsxs("button",{onClick:()=>F(s,i),className:R("text-[10px] font-bold px-3 py-1.5 rounded-lg border transition-all active:scale-95",E?"bg-rose-600 text-white border-rose-700 shadow-sm hover:bg-rose-700":"bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 border-rose-100 dark:border-rose-900/30 hover:bg-rose-100 dark:hover:bg-rose-900/30"),children:["M",i]},i)}),r.length>1&&e.jsx("button",{onClick:()=>L(s),className:"text-[10px] font-black uppercase text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-lg border border-blue-100 dark:border-blue-900/30 hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors flex items-center gap-1",children:"Bayar Sekaligus"})]})})]},s.nim)}),(!m||m.length===0)&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-emerald-100 dark:bg-emerald-900/20 rounded-full flex items-center justify-center text-emerald-500 dark:text-emerald-400 mb-2",children:e.jsx(_,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-foreground",children:"Tidak Ada Tunggakan"}),e.jsx("p",{className:"text-muted-foreground text-sm max-w-[200px] mx-auto",children:"Semua anggota telah melunasi iuran untuk periode ini."})]})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center space-y-4 bg-card rounded-3xl border border-dashed border-border",children:[e.jsx("div",{className:"w-16 h-16 bg-muted rounded-full flex items-center justify-center text-muted-foreground mb-2",children:e.jsx(W,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-foreground",children:"Belum Ada Pengaturan"}),e.jsx("p",{className:"text-muted-foreground text-sm max-w-[250px] mx-auto",children:"Admin belum mengatur tagihan kas untuk periode ini. Silakan atur terlebih dahulu di pengaturan."})]})]}),e.jsx(k,{isOpen:a.open,onClose:()=>d(s=>({...s,open:!1})),onConfirm:()=>w.mutate(),title:"Konfirmasi Pelunasan",description:a.userId?a.week===null?`Lunasi semua tunggakan (${N(m?.find(s=>s.nim===a.studentNim)||{}).length} minggu) untuk ${a.studentName}?`:`Tandai iuran Minggu ${a.week} untuk ${a.studentName} sebagai lunas?`:"",type:"confirm",confirmLabel:w.isPending?"Memproses...":"Ya, Lunas"}),e.jsx(k,{isOpen:S,onClose:()=>j(!1),title:"Berhasil",description:"Iuran berhasil dilunasi.",type:"success"}),e.jsx(k,{isOpen:b.isOpen,onClose:()=>c({...b,isOpen:!1}),title:"Gagal",description:b.message,type:"error"})]})}export{ae as ArrearsScreen};
